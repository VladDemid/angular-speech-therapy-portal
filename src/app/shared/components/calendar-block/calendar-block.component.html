<div class="fb-security-popup" *ngIf="popupService.appointmentDeatailsPopup" >
   <app-appointment-details-popup (voted) = "makeLessonFromPopup($event)"></app-appointment-details-popup>
</div>

<div class="debug-block" *ngIf="false && !production">
   <p>selectedDay: {{selectedDay}}</p>
   <p>currentFirstDay: {{currentFirstDay}}</p>
   <p>selectedDayOfWeek: {{selectedDayOfWeek}}</p>
   <p>daysOfWeekShedule: {{daysOfWeekShedule | json}}</p>
   <p>selectedHourForLesson: {{selectedHourForLesson}}</p>
   <!-- <p>weeklySchedule: {{inputDoctorInfo.weeklySchedule | json}}</p> -->
</div>

<div class="calendar">
   <div class="calendar-wrapper">
      <div class="calendar-header">
         
         <div class="arrow arrow-left" id="prev-month-arrow" (click)="decreaseMonth()"></div>
         <div class="month">{{monthName}} {{year}}</div>
         <div class="arrow arrow-right" id="next-month-arrow" (click)="increaseMonth()"></div>
      </div>
      <div class="calendar-body">
         <div class="days-of-week">
            <div *ngFor="let dayName of daysOfWeek" class="day-of-week">
               {{dayName}}
            </div>
         </div>
         <div class="days">
            <div class="day" *ngFor="let dayIndex of daysArr; index as i">
               <app-calendar-day [dayIndex] = "i+1" [currentFirstDay]="currentFirstDay" 
               [todayDay]="day" [currentMonth]="currentMonth" [month]="month" [year]="year" 
               [currentYear]="currentYear" [selectedDay]="selectedDay" 
               [doctorShedule]="doctorShedule" [daysOfWeekShedule]="inputDoctorInfo.weeklySchedule" 
               [doctorsLessons]="doctorsLessons" [isCalendarPage]="isCalendarPage"  
               (outDay)="onOutDay($event)" (click)="onDayClick(i+1)"></app-calendar-day>
            </div>
         </div>
         <!-- isCalendarPage: {{isCalendarPage}}
         month: {{month}} <br>
         начало месяца с: {{currentFirstDay}} <br>
         выбранный день: {{selectedDay+1}} <br>
         выбранный час: {{selectedHourForLesson}} -->
      </div>
   </div>
   <!--aside для страницы карточки специалиста (не календарь) -->
   <div class="time-aside time-aside-view" *ngIf="!isCalendarPage">
      <span class="go-to-account-sign" *ngIf='isInProfileModule == "false"'>Для записи к специалисту необзодимо войти в <span class="link" [routerLink]="['/profile/doctors']">личный кабинет</span></span> 
      <div class="day-not-chosen-sign" *ngIf="selectedDay == -1 || !inputDoctorInfo.weeklySchedule[selectedDayOfWeek]">
         <!-- день не выбран -->
         <div class="time-blocker"> 
            Выберите рабочий день специалиста
            <div class="example">
               <div class="not-working-color color-example"></div>
               <p> - не рабочие дни специалиста</p>
            </div>
            <div class="example">
               <div class="working-color color-example"></div>
               <p> - рабочие дни специалиста</p>
            </div>
            <div class="example">
               <div class="choosen-day-color color-example"></div>
               <p> - выбранный день</p>
            </div>
            <div class="example">
               <div class="today-day-color color-example"></div>
               <p> - текущий день</p>
            </div>
         </div>
      </div>
      <!-- карточка доктора-->
         <!-- рабочий день выбран -->
      <div class="day-chosen" *ngIf="selectedDay != -1 && inputDoctorInfo.weeklySchedule[selectedDayOfWeek]">
         <div class="time-selection">
            <div class="time-row" 
            [ngClass]="{'work-hour': inputDoctorInfo.weeklySchedule && inputDoctorInfo.weeklySchedule[selectedDayOfWeek] && time >= inputDoctorInfo.weeklySchedule[selectedDayOfWeek][0] && inputDoctorInfo.weeklySchedule[selectedDayOfWeek][1] >= time, 
                        'selected-hour': selectedHourForLesson == time}"
            *ngFor="let time of workHoursArray; index as i" >
               <div class="time-row-inner" (click)="onClickTimeRow(time)">
                  <div class="period">
                     {{time | timeRow}}
                  </div>
                  <div class="patient" *ngIf="doctorEventsYearMonthDayHour && doctorEventsYearMonthDayHour[year] && doctorEventsYearMonthDayHour[year][month] && doctorEventsYearMonthDayHour[year][month][selectedDay+1] && doctorEventsYearMonthDayHour[year][month][selectedDay+1][time]">
                     <!-- {{doctorsLessons[year][month][selectedDay+1][time].name}} -->
                     <div class="busy-sign" *ngIf="doctorEventsYearMonthDayHour[year][month][selectedDay+1][time].patientName != (userData.myData.surname + ' ' + userData.myData.name + ' ' + userData.myData.patronymic)">
                        Занято
                     </div>
                     <div class="busy-myself-sign" *ngIf="doctorEventsYearMonthDayHour[year][month][selectedDay+1][time].patientName == (userData.myData.surname + ' ' + userData.myData.name + ' ' + userData.myData.patronymic)">
                        моя запись
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <button [routerLink]="['/profile/doctors']" *ngIf='isInProfileModule == "false"'>В личный кабинет</button>
         <!-- <button [disabled]="selectedHourForLesson == -1" (click)="makeAnAppointment(year, month, selectedDay+1, selectedHourForLesson)" *ngIf='isInProfileModule == "true"'>Записаться(стар)</button> -->
         <button [disabled]="selectedHourForLesson == -1" (click)="appointmentDeatails(year, month, selectedDay+1, selectedHourForLesson)" *ngIf='isInProfileModule == "true" && selectedHourForLesson != -1'>Записаться</button>
         <button [disabled]="true" *ngIf='selectedHourForLesson == -1'>выберите час</button>
         <div class="doctor-alert error" *ngIf="errorMakingLesson">
            {{errorMakingLesson}}
         </div>
      </div>
   </div>
   <!-- для страницы календаря (profile/calendar) -->
      <!-- день не выбран -->
   <div class="time-aside time-aside-edit" *ngIf="isCalendarPage" [ngClass]="{'downloading': updatingdWorkHourData}">
      <div class="time-aside-doctor" *ngIf="userData.myData.userType == 'doctor'" [ngClass]="{'downloading': updatingdWorkHourData}">
         <div class="day-not-chosen-sign" *ngIf="selectedDay == -1">
            <span>Выберите день</span> 
            <div class="time-blocker">
               <div class="example">
                  <div class="not-working-color color-example"></div>
                  <p> - не рабочие дни</p>
               </div>
               <div class="example">
                  <div class="working-color color-example"></div>
                  <p> - рабочие дни</p>
               </div>
               <div class="example">
                  <div class="today-day-color color-example"></div>
                  <p> - текущий день</p>
               </div>
               <div class="example">
                  <div class="choosen-day-color color-example"></div>
                  <p> - выбранный день</p>
               </div>
            </div>
            <div class="my-lessons" *ngIf="userData.myData.events">
               Предстоящие занятия:
               <div class="lesson-card" 
                  *ngFor="let item of userData.myData.events | lessonsView:currentYear:currentMonth:day:currentHour"
                  [ngClass]="{'selected': item[1].date.day == selectedDay + 1}">
                  <div class="status" [ngClass]="{'unconfirmed': item[1].doctorsConfirmation == false, 'confirmed': item[1].doctorsConfirmation == true}">
                  </div>
                  <div class="date">
                     <span class="days-left" *ngIf="item[1].daysLeft > 1">
                        Через {{item[1].daysLeft - 1}} дней,
                     </span>
                     <span *ngIf="item[1].daysLeft == 0">
                        Сегодня,
                     </span>
                     <span *ngIf="item[1].daysLeft == 1">
                        Завтра,
                     </span>
                     {{item[1].date.day}} {{monthsNamesWhomCase[item[1].date.month - 1]}}</div>
                  <div class="time">{{item[1].time | timeRow}}</div>
                  <div class="doctor-name">{{item[1].patientName}}</div>
                  <div class="problem">{{item[1].problemDescription}}</div>
                  <button (click)="popupService.toggleEventDetailsPopup(); popupService.eventDetails = item[1]">подробнее</button>
                  <button (click)="confirmEvent(item[0])">подтвердить</button>
                  
                  <!-- <div class="zoom">{{item[1].zoom.link}}</div> -->
               </div>
            </div>
         </div>
         <!-- календарь доктора -->
            <!-- рабочий день выбран -->
         <div class="time-of-day-chosen" *ngIf="selectedDay != -1">
            Мои часы работы (по Москве):
            <div class="time-selection">
               <div class="time-row" 
               [ngClass]="{'work-hour': daysOfWeekShedule && daysOfWeekShedule[selectedDayOfWeek] && time >= daysOfWeekShedule[selectedDayOfWeek][0] && daysOfWeekShedule[selectedDayOfWeek][1] >= time, 
                           'lesson-appointed': userData.myData.eventsDates && userData.myData.eventsDates[year] && userData.myData.eventsDates[year][month] && userData.myData.eventsDates[year][month][selectedDay+1] && userData.myData.eventsDates[year][month][selectedDay+1][time]}"
               *ngFor="let time of workHoursArray; index as i" >
                  <div class="time-row-inner" >
                     <div class="period">
                        {{time | timeRow}}
                     </div>
                     <div class="patient" *ngIf="userData.myData.eventsDates && userData.myData.eventsDates[year] && userData.myData.eventsDates[year][month] && userData.myData.eventsDates[year][month][selectedDay+1] && userData.myData.eventsDates[year][month][selectedDay+1][time]">
                        {{userData.myData.eventsDates[year][month][selectedDay+1][time].patientName | textCutter:25}}
                     </div>
                  </div>
               </div>
            </div>
            <div class="go-back" (click)="unselectDay()">к списку занятий</div>
         </div>
      </div>
      <div class="time-aside-client" *ngIf="userData.myData.userType == 'client'">
         <div class="no-lessons-sign" *ngIf="!userData.myData.events">
            у вас пока нет занятий
         </div>
         <div class="my-lessons" *ngIf="userData.myData.events">
            Предстоящие занятия:
            <div class="lesson-card"  
               *ngFor="let item of userData.myData.events | lessonsView:currentYear:currentMonth:day:currentHour"
               [ngClass]="{selected: item[1].date.day == selectedDay + 1}">
               <div class="status" [ngClass]="{'unconfirmed': item[1].doctorsConfirmation == false, 'confirmed': item[1].doctorsConfirmation == true}">
               </div>
               <div class="date">
                  <span class="days-left" *ngIf="item[1].daysLeft > 1">
                     Через {{item[1].daysLeft - 1}} дней,
                  </span>
                  <span *ngIf="item[1].daysLeft == 0">
                     Сегодня,
                  </span>
                  <span *ngIf="item[1].daysLeft == 1">
                     Завтра,
                  </span>
                  {{item[1].date.day}} {{monthsNamesWhomCase[item[1].date.month - 1]}}</div>
               <div class="time">{{item[1].time | timeRow}}</div>
               <div class="doctor-name">{{item[1].doctorName}}</div>
               <div class="problem">{{item[1].problemDescription}}</div>
               <button (click)="popupService.toggleEventDetailsPopup(); popupService.eventDetails = item[1]">подробнее</button>
            </div>
         </div>
      </div>
   </div>
</div>

<div class="change-shedule-block" *ngIf="isCalendarPage && userData.myData.userType == 'doctor'">
   <div class="debug" *ngIf="false && helper.DEBUG">
      <div class="">daysOfWeekShedule:{{daysOfWeekShedule | json}}</div>
      <div class="">newDaysOfWeekShedule: {{newDaysOfWeekShedule | json}}</div>

   </div>
   <div class="days-selection-wrapper">
   <h3>Рабочее время</h3>
      <div class="days-of-week-selection">
         <!-- <div class="days-sign">Выберите удобные для вас дни</div> -->
         <div class="days-of-week-checkboxes">
            <div class="day-of-week" 
               *ngFor="let item of daysOfWeek; index as i" 
               (click)="changeActiveDaysOfWeek(i)"
               [ngClass]="{active: newDaysOfWeekShedule[i]}">
               <span>{{item}}</span>
            </div>
            
         </div>
         <!-- <div class="lesson-duration-description">
            Стандартная продолжительность занятий - 
            <span>40 минут</span>
         </div> -->
      </div>
      <div class="days-of-week-settings">
         <!-- <div class="days-sign" >Ваше рабочее время</div> -->
         <div class="days-of-week-aside-rows">
            <div class="time-row" 
            *ngFor="let item of daysOfWeek; index as i"
            [ngClass]="{active: newDaysOfWeekShedule[i]}"> 
               <span>{{item}}</span>
               <div class="active-row row-settings" *ngIf="newDaysOfWeekShedule[i]">
                  <div class="row-setting from">
                     <span>{{newDaysOfWeekShedule[i][0]}}</span>
                     <div class="increase time-setting-button" (click)="changeWorkHour(1, i, 0)"></div>
                     <div class="decrease time-setting-button" (click)="changeWorkHour(-1, i, 0)"></div>
                  </div>
                  <div class="row-setting to">
                     <span>{{newDaysOfWeekShedule[i][1]}}</span>
                     <div class="increase time-setting-button" (click)="changeWorkHour(1, i, 1)"></div>
                     <div class="decrease time-setting-button" (click)="changeWorkHour(-1, i, 1)"></div>
                  </div> 
               </div>
               <div class="disabled-row row-settings" *ngIf="!newDaysOfWeekShedule[i]">не рабочий день</div>
            </div>
         </div>
      </div>
   </div>
   <div class="buttons">
      <button class="cancel" (click)="cancelNewShedule()">
         отмена 
      </button>
      <button class="submit-new-shedule" (click)="sendNewShedule()" [ngClass]="{updating: updatingdWorkHourData}">
         сохранить изменения
      </button>
   </div>
</div>
<!-- UPDATING: {{updatingdWorkHourData}} -->
<!-- {{doctorShedule | json}} -->
